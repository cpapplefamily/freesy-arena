{{/*
Copyright 2025 Freesy Arena. All Rights Reserved.
Author: brandon@brandon-moe.com (Brandon Moe)

Display for managing open queue.
*/}}
<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <title>Open Queue Admin - {{.EventSettings.Name}} - Cheesy Arena</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="shortcut icon" href="/static/img/favicon.ico">
  <link href="/static/css/lib/bootstrap.min.css" rel="stylesheet">
  <link href="/static/css/lib/bootstrap-icons.min.css" rel="stylesheet">
  <link href="/static/css/lib/tempus-dominus.min.css" rel="stylesheet">
  <link href="/static/css/cheesy-arena.css" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- <link rel="stylesheet" href="/static/css/field_monitor_display.css" /> -->
</head>

<body>
  <div id="header" class="row justify-content-center">
    <div class="col-lg-5">Open Queue Admin</div>
    <div class="col-lg-5 text-end">{{.EventSettings.Name}}</div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <!-- Current match and next match -->
        <div class="col-lg-5 text-end">{{.EventSettings}}</div>
        <h4>Current Match</h4>
        <div class="row text-center">
          <div class="col-lg-6 card card-body bg-blue mb-2">
            <div class="row mb-3">
              <div class="col-lg-4">Blue Teams</div>
              {{template "currentMatchPlayTeam" dict "color" "B" "position" 1 "data" .}}
              {{template "currentMatchPlayTeam" dict "color" "B" "position" 2 "data" .}}
              {{template "currentMatchPlayTeam" dict "color" "B" "position" 3 "data" .}}
              <div id="playoffBlueAllianceInfo"></div>
            </div>
          </div>
          <div class="col-lg-6 card card-body bg-red mb-2">
            <div class="row mb-3">
              <div class="col-lg-4">Red Teams</div>
              {{template "currentMatchPlayTeam" dict "color" "R" "position" 3 "data" .}}
              {{template "currentMatchPlayTeam" dict "color" "R" "position" 2 "data" .}}
              {{template "currentMatchPlayTeam" dict "color" "R" "position" 1 "data" .}}
              <div id="playoffRedAllianceInfo"></div>
            </div>
          </div>
        </div>
        <h4>Next Match</h4>
        <div class="row text-center">
          <div class="col-lg-6 card card-body bg-blue mb-2">
            <div class="row mb-3">
              <div class="col-lg-4">Blue Teams</div>
              {{template "nextMatchPlayTeam" dict "color" "B" "position" 1 "data" .}}
              {{template "nextMatchPlayTeam" dict "color" "B" "position" 2 "data" .}}
              {{template "nextMatchPlayTeam" dict "color" "B" "position" 3 "data" .}}
              <div id="playoffBlueAllianceInfo"></div>
            </div>
          </div>
          <div class="col-lg-6 card card-body bg-red mb-2">
            <div class="row mb-3">
              <div class="col-lg-4">Red Teams</div>
              {{template "nextMatchPlayTeam" dict "color" "R" "position" 3 "data" .}}
              {{template "nextMatchPlayTeam" dict "color" "R" "position" 2 "data" .}}
              {{template "nextMatchPlayTeam" dict "color" "R" "position" 1 "data" .}}
              <div id="playoffRedAllianceInfo"></div>
            </div>
          </div>
        </div>
        <div class="text-center mt-3">
          <button class="btn btn-primary" onclick="moveNextMatchToCurrent()">Move Next Match to Current</button>
        </div>
      </div>
      <div class="col-md-6">
        <!-- Current Queue -->
        <h3 class="col-lg-5">Current Queue</h3>
        {{template "queued_teams" .}}
      </div>
    </div>
    <div class="row">
      <h3 class="col-lg-5">All Teams</h3>
      <div class="col-12 d-flex flex-wrap gap-2">
        <!-- Team List -->
        {{template "all_teams_queue" .}}
      </div>
    </div>
  </div>
</body>
<script src="/static/js/lib/jquery.min.js"></script>
<script src="/static/js/lib/jquery.json-2.4.min.js"></script>
<script src="/static/js/lib/jquery.websocket-0.0.1.js"></script>
<script src="/static/js/cheesy-websocket.js"></script>
<script src="/static/js/lib/jquery.transit.min.js"></script>
<script src="/static/js/lib/bootstrap.bundle.min.js"></script>
{{template "script" .}}
{{template "script_queue" .}}

</html>

<!-- Match Scheduling -->
{{define "currentMatchPlayTeam"}}
<div class="row mb-2" id="status{{.color}}{{.position}}">
  <div class="col-lg-1">{{.position}} </div>
  <div class="col-lg-12">
    <input type="number" class="team-number form-control" onchange="substituteTeams();">
  </div>
</div>
{{end}}

{{define "nextMatchPlayTeam"}}
<div class="row mb-2" id="nextstatus{{.color}}{{.position}}">
  <div class="col-lg-1">{{.position}} </div>
  <div class="col-lg-12">
    <input type="number" class="team-number form-control">
  </div>
</div>
{{end}}

<script>
  var websocket;
  const substituteTeams = function (team, position) {
    const teams = {
      Red1: getTeamNumber("R1"),
      Red2: getTeamNumber("R2"),
      Red3: getTeamNumber("R3"),
      Blue1: getTeamNumber("B1"),
      Blue2: getTeamNumber("B2"),
      Blue3: getTeamNumber("B3"),
    };

    console.log(teams);

    websocket.send("substituteTeams", teams);
  };

  const getTeamNumber = function (station) {
    const teamId = $(`#status${station} .team-number`).val().trim();
    return teamId ? parseInt(teamId) : 0;
  }

  const handleMatchLoad = function (data) {
    isReplay = data.IsReplay;

    fetch("/match_play/match_load")
      .then(response => response.text())
      .then(html => $("#matchListColumn").html(html));

    $.each(data.Teams, function (station, team) {
      const teamId = $(`#status${station} .team-number`);
      teamId.val(team ? team.Id : "");
      teamId.prop("disabled", !data.AllowSubstitution);
    });
  }

  $(function () {
    // Set up the websocket back to the server.
    websocket = new CheesyWebsocket("/displays/open_queue/websocket", {
      matchLoad: function (event) { handleMatchLoad(event.data); },
    });
  });

  const moveNextMatchToCurrent = function () {
    const nextMatchTeams = {
      Red1: getTeamNumber("R1"),
      Red2: getTeamNumber("R2"),
      Red3: getTeamNumber("R3"),
      Blue1: getTeamNumber("B1"),
      Blue2: getTeamNumber("B2"),
      Blue3: getTeamNumber("B3"),
    };

    // Assuming you have a function to set the current match teams
    setCurrentMatchTeams(nextMatchTeams);
  };

  const setCurrentMatchTeams = function (teams) {
    $.each(teams, function (station, team) {
      $(`#status${station} .team-number`).val(team);
    });
  };
</script>